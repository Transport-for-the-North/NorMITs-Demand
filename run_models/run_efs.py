# -*- coding: utf-8 -*-
"""
Created on: Wed January 27 12:31:12 2021
Updated on:

Original author: Ben Taylor
Last update made by:
Other updates made by:

File purpose:
Running test runs of EFS
"""
import sys

sys.path.append("..")
import normits_demand as nd
from normits_demand import constants as consts
from normits_demand import efs_constants as efs_consts

from normits_demand.utils import exceptional_growth as eg

# TODO(MB) Integrate into `run_forecast` front-end script

def main():
    verbose = False

    # Land Use imports
    land_use_drive = "I:/"
    by_land_use_iteration = 'iter3d'
    fy_land_use_iteration = 'iter3d'

    # Running control
    integrate_dlog = False
    run_pop_emp_comparison = False
    apply_wfh_adjustments = True

    # Base EFS
    run_base_efs = False
    recreate_productions = False
    recreate_attractions = False
    recreate_nhb_productions = False
    combine_internal_external = False

    # Running options
    run_bespoke_zones = False
    ignore_bespoke_zones = True
    use_elasticity_to_od = True

    # Compiling matrices
    run_pa_to_od = False
    run_compile_mats = True
    run_decompile_post_me = True

    # Controls matrix conversion
    # output_years = efs_consts.ALL_YEARS
    output_years = efs_consts.FUTURE_YEARS

    # Controls I/O
    scenario = consts.SC01_JAM
    iter_num = '3i'
    import_home = "I:/"
    export_home = "I:/"
    # export_home = "I:/"
    model_name = efs_consts.MODEL_NAME

    # ## RUN START ## #
    efs = nd.ExternalForecastSystem(
        iter_num=iter_num,
        model_name=model_name,
        integrate_dlog=integrate_dlog,
        run_pop_emp_comparison=run_pop_emp_comparison,
        apply_wfh_adjustments=apply_wfh_adjustments,
        scenario_name=scenario,
        import_home=import_home,
        export_home=export_home,
        land_use_drive=land_use_drive,
        by_land_use_iteration=by_land_use_iteration,
        fy_land_use_iteration=fy_land_use_iteration,
        verbose=verbose
    )

    print("-" * 40, "Running for %s" % model_name, "-" * 40)

    if run_base_efs:
        # Generates HB PA matrices
        efs.run(
            recreate_productions=recreate_productions,
            recreate_attractions=recreate_attractions,
            recreate_nhb_productions=recreate_nhb_productions,
            combine_internal_external=combine_internal_external,
            echo_distribution=verbose,
        )

    if run_bespoke_zones:
        # Convert to HB to OD
        efs.old_pa_to_od(
            years_needed=[2018],
            p_needed=consts.ALL_HB_P,
            use_bespoke_pa=False,
            overwrite_hb_tp_pa=True,
            overwrite_hb_tp_od=True,
            verbose=verbose
        )

        eg.adjust_bespoke_zones(
            efs_consts.BESPOKE_ZONES_INPUT_FILE,
            efs.exports,
            efs.model_name,
            base_year=efs_consts.BASE_YEAR_STR,
            recreate_donor=True,
            audit_path=efs.exports["audits"],
        )

    if run_pa_to_od:
        efs.pa_to_od(
            years_needed=output_years,
            use_bespoke_pa=(not ignore_bespoke_zones),
            use_elasticity_pa=use_elasticity_to_od,
            verbose=verbose
        )

    if run_compile_mats:
        efs.compile_matrices(
            years=output_years,
            use_bespoke_pa=(not ignore_bespoke_zones),
            use_elasticity_pa=use_elasticity_to_od,
        )

    if run_decompile_post_me:
        # Decompiles post-me base year matrices
        efs.decompile_post_me(
            overwrite_decompiled_matrices=True,
            overwrite_tour_proportions=True,
        )


if __name__ == '__main__':
    main()
